/*modules/encyclopedia/encyclopedia*/
define("modules/encyclopedia/encyclopedia",["can/","controller","select2","core/appState","js/app/user/modules/encyclopedia/encyclopediaHelpers","lib/subscribe/","lib/up-btn/","custom-scrollbar"],function(e,t,i,a,s,r,l,n){"use strict";e&&e.__esModule||(e={"default":e}),t&&t.__esModule||(t={"default":t}),i&&i.__esModule||(i={"default":i}),a&&a.__esModule||(a={"default":a}),s&&s.__esModule||(s={"default":s}),r&&r.__esModule||(r={"default":r}),l&&l.__esModule||(l={"default":l}),n&&n.__esModule||(n={"default":n});var c=e["default"],o=t["default"],d=(i["default"],a["default"]),h=s["default"],u=r["default"],f=l["default"],m=c.Model.extend({findAll:"POST /themes/findAll",parseModels:function(e){return e.data.themes}},{}),p=(c.Model.extend({findAll:"POST /articles/findAll",parseModels:function(e){return e.data.articles}},{}),o.extend({defaults:{}},{variables:function(){this.active="active",this.age_blocks=this.element.find(".age_block"),this.theme_filter=this.element.find(".theme_filter"),this.bookshelf=this.theme_filter.find(".bookshelf"),this.items_container=this.element.find(".items_container")},plugins:function(){this.setFilterHeight(),this.select2(),new f(this.element)},select2:function(){var e={width:"off",minimumResultsForSearch:-1,formatResult:this.format},t=this.element.find(".author_select"),i=this.element.find(".order_select");t.select2(e),i.select2(e)},format:function(e){var t=$(e.element),i=t.data("count"),a='<div class="adorable_table encyclopedia_select2_result"><div class="adorable_cell"><span>'+e.text+"</span>"+("undefined"!=typeof i?'<div class="count">'+i+"</div>":"")+"</div></div>";return a},setFilterHeight:function(){var e=d.attr("viewport").getViewportHeight(),t=this.element.find(".age_filter"),i=t.height();this.element.find(".filter").height(this.filterHeight=e>=i?e:i)},"{window} resize":function(){this.setFilterHeight(),this.setScroll(),this.reRenderArticles()},after_init:function(e){this.articlesSource=e?e.articles.documents:app.articles.documents,this.articlesNextId=e?e.articles.nextAnchorId:app.articles.nextAnchorId,(this.articlesSource.length<24||1==this.articlesNextId||!this.articlesNextId)&&(this.noMoreArts=!0,this.element.find(".loadMore").hide()),this.isXL(e?e.themes:app.themes);var t,i,a=this,s=h.sortArticles(this.articlesSource,null,c.proxy(this.isXL,this));this.first_call=!0;var r=c.Map.extend({define:{age:{value:function(){var e=c.route.attr("id");return e?e:null}},theme:{value:function(){var e=c.route.attr("param2");return e?e:null}},themes:{value:new c.List(e?e.themes:app.themes),get:function(e){var t={age:this.attr("age")};return a.first_call||e.replace(m.findAll(t)),e}}},ages:e?e.ages:app.ages,articles:s,sort:"desc",filter:0,module:"encyclopedia"});this.data=new r;var l=$("#bookshelf_mustache"),n=$("#encyclopedia_mustache");l.length?(i=l.html(),t=n.html()):(i=jadeTemplate.get("user/encyclopedia/bookshelf_mustache"),t=jadeTemplate.get("user/encyclopedia/encyclopedia_mustache")),c.view.mustache("bookshelf",i),c.view.mustache("encyclopedia_view",t),this.bookshelf.html(c.view("bookshelf",this.data,h)),this.items_container.html(c.view("encyclopedia_view",this.data,h)),this.first_call=!1},isXL:function(e){if(void 0!==this.isFirstXl)return this.isFirstXl;var t=this.data?this.data.attr("theme"):c.route.attr("param2");return this.isFirstXl=e.length?_.find(e,{_id:t}).isFirstCardXL||!1:!1,this.isFirstXl},reRenderArticles:function(){if(this.data){var e=h.sortArticles(this.getFilteredData(),this.data.attr("sort"),c.proxy(this.isXL,this));this.data.attr("articles",e)}},getFilteredData:function(){var e=this.data.attr("filter");switch(e){case 0:return this.articlesSource;case"Статья от редакции":case"Статья от специалиста":return _.filter(this.articlesSource,function(t){return t.type.name==e});case"Тема недели":return _.filter(this.articlesSource,function(e){return e.recommended})}},".age_block click":function(e){var t=e.data("value").toString();this.age_blocks.removeClass(this.active),e.addClass(this.active),this.data.attr("age",t),this.theme_filter.addClass(this.active),this.setScroll()},setScroll:function(){$(".filterContent",this.element).mCustomScrollbar({scrollInertia:0})},".book click":function(e){this.element.find(".book").removeClass(this.active),e.addClass(this.active),this.data.attr("theme",e.data("theme"));var t=this.data.attr("age")||null,i=e.data("theme")||null;router.new_module("encyclopedia"+(t?"/"+t:"")+(i?"/"+i:""))},".theme_filter .close click":function(){this.theme_filter.removeClass(this.active)},".order_select change":function(e){var t=e.val();this.data.attr("sort","date"===t?"desc":"asc"),this.reRenderArticles()},".author_select change":function(e){this.data.attr("filter",e.val()),this.reRenderArticles()},".subscribeIt click":function(){var e=this;u.subscribe(this.data.attr("theme"),function(){e.element.find(".subscribeIt").hide(),e.element.find(".unSubscribeIt").show()})},".unSubscribeIt click":function(){var e=this;u.unsubscribe(this.data.attr("theme"),function(){e.element.find(".unSubscribeIt").hide(),e.element.find(".subscribeIt").show()})},".loadMore img click":function(e){var t=this,i=t.data.attr("articles"),a={lastId:t.articlesNextId};t.noMoreArts||(t.data.attr("theme")&&t.data.attr("age")&&(a.age={_id:_.find(t.data.attr("ages").attr(),{value:+t.data.attr("age")})._id},a.theme={_id:t.data.attr("theme")},a.nestedAnchor={wrap:"theme",field:"_id",value:t.data.attr("theme"),anchorField:"position"},a.sort={"theme.position":-1}),c.ajax({url:"/articles",method:"get",dataType:"json",data:a}).done(function(a){var s=h.sortArticles(a.documents,t.data.attr("sort"),c.proxy(t.isXL,t));t.articlesNextId=a.nextAnchorId,c.batch.start(),_.each(s,function(e){i.push(e)}),c.batch.stop(),(a.documents.length<24||1==t.articlesNextId||!t.articlesNextId)&&(t.noMoreArts=!0,e.parent().hide())}))}}));return{get default(){return p},__esModule:!0}});
