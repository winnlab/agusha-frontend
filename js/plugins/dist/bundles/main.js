/*modules/main/main*/
define("modules/main/main",["controller","core/appState","js/app/user/modules/encyclopedia/encyclopediaHelpers","select2","carousel"],function(e,t,a,s,i){"use strict";e&&e.__esModule||(e={"default":e}),t&&t.__esModule||(t={"default":t}),a&&a.__esModule||(a={"default":a}),s&&s.__esModule||(s={"default":s}),i&&i.__esModule||(i={"default":i});var n=e["default"],r=t["default"],c=a["default"],l=n.extend({defaults:{}},{variables:function(){this.classname="active",this.tab_selectors=this.element.find(".tab_selector"),this.bannerWrap=this.element.find(".bannerWrap"),this.userTitle=this.element.find(".userTitle"),this.items_container=this.element.find(".items_container"),this.feed_container=this.element.find(".feed_container"),this.icons=this.element.find(".icon"),this.carousel=this.element.find("#main_carousel")},plugins:function(){this.init_carousel()},init_carousel:function(){this.carousel.carousel()},initPlugins:function(){var e=this;this.select2(),r.delegate("subsChanged","set",function(t,a){a&&e.updateSubscribe()}),r.attr("user").user().bind("change",function(){if(r.attr("user")&&r.attr("user").user()&&r.attr("user").user()._id){e.element.find(".carousel_container").hide();var t=r.attr("user").user().attr("profile.first_name");e.element.find(".breadcrumbs span").html("/ "+t),e.element.find(".username").html(t)}else e.element.find(".carousel_container").show()}),can.bind.call(r,"toggleWatch",can.proxy(this.toggleWatch,this))},toggleWatch:function(e,t,a){var s=(r.attr("user").user().attr("_id"),_.findIndex(this.data.attr("feed"),{_id:t}));return-1===s?(this.data.attr("feed").push(a),void this.feedSource.push(a)):(this.data.attr("feed").splice(s,1),void this.feedSource.splice(_.findIndex(this.feedSource,{_id:t}),1))},select2:function(){var e={width:"off",minimumResultsForSearch:-1,formatResult:this.format},t=this.element.find(".feed_select"),a=this.element.find(".order_select");t.select2(e),a.select2(e)},format:function(e){var t=$(e.element),a=t.data("count"),s='<div class="adorable_table main_select2_result"><div class="adorable_cell"><span>'+e.text+"</span>"+("undefined"!=typeof a?'<div class="count">'+a+"</div>":"")+"</div></div>";return s},after_init:function(e){var t=r.attr("user").auth;this.isAuth(null,t.attr("isAuth")),t.delegate("isAuth","set",can.proxy(this.isAuth,this)),this.articlesSource=e?e.articles.documents:app.articles.documents,this.articlesNextId=e?e.articles.nextAnchorId:app.articles.nextAnchorId,this.themeSubs=e?e.themeSubs:app.themeSubs,this.consultations=e?e.consultations:app.consultations,this.feedSource=[].concat(this.themeSubs,this.consultations),(this.articlesSource.length<24||1==this.articlesNextId||!this.articlesNextId)&&(this.noMoreArts=!0,this.element.find(".loadMore").hide());var a,s,i=c.sortArticles(this.articlesSource,null,!0,!0),n=c.sortArticles(this.feedSource,null,!0,!0);this.data=new can.Map({articles:i,feed:n,feedLength:this.feedSource.length,sort:"desc",filter:0,iconFilter:null,feedFilter:0,module:"main",themeSubs:e?e.themeSubs.length:app.themeSubs.length,authorSubs:0,consultations:e?e.consultations.length:app.consultations.length});var l=$("#encyclopedia_mustache"),o=$("#feed_mustache");l.length?(a=l.html(),s=o.html()):(a=jadeTemplate.get("user/encyclopedia/encyclopedia_mustache"),s=jadeTemplate.get("user/main/feed_mustache")),can.view.mustache("mainArticlesView",a),can.view.mustache("feedView",s),this.items_container.html(can.view("mainArticlesView",this.data,c)),this.feed_container.html(can.view("feedView",this.data,c)),this.initPlugins()},updateSubscribe:function(){var e=this;can.ajax({url:"/feed",method:"GET"}).done(function(t){e.themeSubs=t?t.themeSubs:[],e.consultations=t?t.consultations:[],e.feedSource=[].concat(e.themeSubs,e.consultations);var t=e.getFilteredData(),a=c.sortArticles(t,e.data.attr("sort"),!0,!0);e.data.attr("feed",a),e.data.attr("feedLength",e.feedSource.length),e.data.attr("themeSubs",e.themeSubs.length),e.data.attr("consultations",e.consultations.length),r.attr("subsChanged",!1)}).fail(function(){console.error(arguments)})},isAuth:function(e,t){var a=this;t?(a.element.find(".mainModuleWrap").addClass("logedIn"),a.bannerWrap.hide(),a.element.find(".commonFeed").hide(),a.userTitle.css("display","inline-block")):(a.element.find(".mainModuleWrap").removeClass("logedIn"),a.userTitle.hide(),a.element.find(".commonFeed").show(),a.bannerWrap.show())},".tab click":function(e){var t=e.data("tab");this.tab_selectors.removeClass(this.classname),this.tab_selectors.filter("."+t).addClass(this.classname)},"{window} resize":function(){this.reRenderArticles(),this.reRenderFeed()},reRenderArticles:function(){if(this.data){var e=c.sortArticles(this.articlesSource,null,!0,!0);this.data.attr("articles",e)}},reRenderFeed:function(){if(this.data){var e=this.getFilteredData(),t=c.sortArticles(e,this.data.attr("sort"),!0,!0);this.data.attr("feed",t)}},".order_select change":function(e){var t=e.val();this.data.attr("sort","date"===t?"asc":"desc"),this.reRenderFeed()},".icon click":function(e){var t,a,s=this.data.attr("iconFilter"),i=e.data("filter"),n=this.getFilteredData(),l=i==s?!1:i;this.icons.removeClass("active"),e.addClass("active"),t=_.filter(n,function(e){if(!l)return!0;switch(l){case"watchers":var t=r.attr("user").user().attr("_id");return!(!e.watchers||-1===e.watchers.indexOf(t));case"recommended":return!!e.recommended;case"spec":return!!_.find(e.answer,function(e){return!!e.specialist})}return!1}),this.data.attr("iconFilter",i),a=c.sortArticles(t,this.data.attr("sort"),!0,!0),this.data.attr("feed",a)},".feed_select change":function(e){var t=+e.val();0===t&&this.data.attr("iconFilter",!1),this.data.attr("feedFilter",t),this.reRenderFeed()},getFilteredData:function(){var e=this.data.attr("feedFilter");return 0===e?this.feedSource:1===e?this.themeSubs:2===e?[]:3===e?this.consultations:void 0},".loadMore img click":function(e){var t=this,a=t.data.attr("articles");t.noMoreArts||can.ajax({url:"/articles",method:"get",dataType:"json",data:{lastId:t.articlesNextId}}).done(function(s){_.each(s.documents,function(e){t.articlesSource.push(e)});var i=c.sortArticles(t.articlesSource,null,!0,!0);t.articlesNextId=s.nextAnchorId,can.batch.start(),_.each(i,function(e,t){a.attr(t)||a.push(e)}),can.batch.stop(),(s.documents.length<24||1==t.articlesNextId||!t.articlesNextId)&&(t.noMoreArts=!0,e.parent().hide())})},"a.carousel-control click":function(e,t){t.preventDefault()},".carousel-control.left click":function(){ga("set","page",decodeURI(document.location.href)),ga("send","event","MainCarousel","Left")},".carousel-control.right click":function(){ga("set","page",decodeURI(document.location.href)),ga("send","event","MainCarousel","Right")},".registration_button click":function(){ga("set","page",decodeURI(document.location.href)),ga("send","event","Registration","MainBanner")}});return{get default(){return l},__esModule:!0}});
