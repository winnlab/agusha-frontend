/*modules/main/main*/
define("modules/main/main",["can/","controller","core/appState","js/app/user/modules/encyclopedia/encyclopediaHelpers","lib/up-btn/","select2","carousel"],function(e,t,s,a,i,n,r){"use strict";e&&e.__esModule||(e={"default":e}),t&&t.__esModule||(t={"default":t}),s&&s.__esModule||(s={"default":s}),a&&a.__esModule||(a={"default":a}),i&&i.__esModule||(i={"default":i}),n&&n.__esModule||(n={"default":n}),r&&r.__esModule||(r={"default":r});var l=e["default"],o=t["default"],c=s["default"],d=a["default"],u=i["default"],h=o.extend({defaults:{}},{variables:function(){this.classname="active",this.tab_selectors=this.element.find(".tab_selector"),this.bannerWrap=this.element.find(".bannerWrap"),this.userTitle=this.element.find(".userTitle"),this.items_container=this.element.find(".items_container"),this.feed_container=this.element.find(".feed_container"),this.registration_block=this.element.find(".registration_block"),this.carousel=this.element.find("#main_carousel"),this.counter_block=this.element.find(".counter_block")},plugins:function(){this.init_carousel()},init_carousel:function(){var e=this;this.carousel.carousel({interval:!1}),this.carousel.on("slide.bs.carousel",function(){e.registration_block.removeClass("animate").addClass("no-transition"),setTimeout(function(){e.registration_block.removeClass("no-transition").addClass("animate")},4)})},initPlugins:function(){var e=this;this.select2(),new u(this.element),c.delegate("subsChanged","set",function(t,s){s&&e.updateSubscribe()}),c.attr("user").user().bind("change",function(){if(c.attr("user")&&c.attr("user").user()&&c.attr("user").user()._id){e.element.find(".carousel_container").hide();var t=c.attr("user").user().attr("profile.first_name");e.element.find(".breadcrumbs span").html("/ "+t),e.element.find(".username").html(t)}else e.element.find(".carousel_container").show()}),l.bind.call(c,"toggleWatch",l.proxy(this.toggleWatch,this))},toggleWatch:function(e,t,s){var a=(c.attr("user").user().attr("_id"),_.findIndex(this.data.attr("feed"),{_id:t}));return-1===a?(this.data.attr("feed").push(s),void this.feedSource.push(s)):(this.data.attr("feed").splice(a,1),void this.feedSource.splice(_.findIndex(this.feedSource,{_id:t}),1))},select2:function(){var e={width:"off",minimumResultsForSearch:-1,formatResult:this.format},t=this.element.find(".feed_select"),s=this.element.find(".order_select");t.select2(e),s.select2(e)},format:function(e){var t=$(e.element),s=t.data("count"),a='<div class="adorable_table main_select2_result"><div class="adorable_cell"><span>'+e.text+"</span>"+("undefined"!=typeof s?'<div class="count">'+s+"</div>":"")+"</div></div>";return a},after_init:function(e){var t=c.attr("user").auth;this.isAuth(null,t.attr("isAuth")),t.delegate("isAuth","set",l.proxy(this.isAuth,this)),this.articlesSource=e?e.articles.documents:app.articles.documents,this.articlesNextId=e?e.articles.nextAnchorId:app.articles.nextAnchorId,this.themeSubs=e?e.themeSubs:app.themeSubs,this.consultations=e?e.consultations:app.consultations,this.feedSource=[].concat(this.themeSubs,this.consultations),(this.articlesSource.length<24||1==this.articlesNextId||!this.articlesNextId)&&(this.noMoreArts=!0,this.element.find(".loadMore").hide());var s,a,i=d.sortArticles(this.articlesSource,null,!0,!0),n=d.sortArticles(this.feedSource,null,!0,!0);this.data=new l.Map({articles:i,feed:n,feedLength:this.feedSource.length,sort:"desc",filter:0,iconFilter:null,feedFilter:0,module:"main",themeSubs:e?e.themeSubs.length:app.themeSubs.length,authorSubs:0,consultations:e?e.consultations.length:app.consultations.length});var r=$("#encyclopedia_mustache"),o=$("#feed_mustache");s=r.length?r.html():jadeTemplate.get("user/encyclopedia/encyclopedia_mustache"),a=o.length?o.html():jadeTemplate.get("user/main/feed_mustache"),l.view.mustache("mainArticlesView",s),l.view.mustache("feedView",a),this.items_container.html(l.view("mainArticlesView",this.data,d)),this.feed_container.html(l.view("feedView",this.data,d)),this.initPlugins(),this.icons=this.element.find(".icon")},updateSubscribe:function(){var e=this;l.ajax({url:"/feed",method:"GET"}).done(function(t){e.themeSubs=t?t.themeSubs:[],e.consultations=t?t.consultations:[],e.feedSource=[].concat(e.themeSubs,e.consultations);var t=e.getFilteredData(),s=d.sortArticles(t,e.data.attr("sort"),!0,!0);e.data.attr("feed",s),e.data.attr("feedLength",e.feedSource.length),e.data.attr("themeSubs",e.themeSubs.length),e.data.attr("consultations",e.consultations.length),c.attr("subsChanged",!1)}).fail(function(){console.error(arguments)})},isAuth:function(e,t){var s=this;t?(s.element.find(".mainModuleWrap").addClass("logedIn"),s.bannerWrap.hide(),s.element.find(".commonFeed").hide(),s.userTitle.css("display","inline-block")):(s.element.find(".mainModuleWrap").removeClass("logedIn"),s.userTitle.hide(),s.element.find(".commonFeed").show(),s.bannerWrap.show())},".tab click":function(e){var t=e.data("tab");this.tab_selectors.removeClass(this.classname),this.tab_selectors.filter("."+t).addClass(this.classname)},"{window} resize":function(){this.reRenderArticles(),this.reRenderFeed()},reRenderArticles:function(){if(this.data){var e=d.sortArticles(this.articlesSource,null,!0,!0);this.data.attr("articles",e)}},reRenderFeed:function(){if(this.data){var e=this.getFilteredData(),t=d.sortArticles(e,this.data.attr("sort"),!0,!0);this.data.attr("feed",t)}},".order_select change":function(e){var t=e.val();this.data.attr("sort","date"===t?"asc":"desc"),this.reRenderFeed()},".icon click":function(e){var t,s,a=this.data.attr("iconFilter"),i=e.data("filter"),n=this.getFilteredData(),r=i==a?!1:i;this.icons.removeClass("active"),this.data.attr("iconFilter")!==i&&e.addClass("active"),t=_.filter(n,function(e){if(!r)return!0;switch(r){case"watchers":var t=c.attr("user").user().attr("_id");return!(!e.watchers||-1===e.watchers.indexOf(t));case"recommended":return!!e.recommended;case"spec":return!!_.find(e.answer,function(e){return!!e.specialist})}return!1}),this.data.attr("iconFilter",i),s=d.sortArticles(t,this.data.attr("sort"),!0,!0),this.data.attr("feed",s)},".feed_select change":function(e){var t=+e.val();0===t&&this.data.attr("iconFilter",!1),this.data.attr("feedFilter",t),this.reRenderFeed()},getFilteredData:function(){var e=this.data.attr("feedFilter");return 0===e?this.feedSource:1===e?this.themeSubs:2===e?[]:3===e?this.consultations:void 0},".loadMore img click":function(e){var t=this,s=t.data.attr("articles");t.noMoreArts||l.ajax({url:"/articles",method:"get",dataType:"json",data:{lastId:t.articlesNextId}}).done(function(a){_.each(a.documents,function(e){t.articlesSource.push(e)});var i=d.sortArticles(t.articlesSource,null,!0,!0);t.articlesNextId=a.nextAnchorId,l.batch.start(),_.each(i,function(e,t){s.attr(t)||s.push(e)}),l.batch.stop(),(a.documents.length<24||1==t.articlesNextId||!t.articlesNextId)&&(t.noMoreArts=!0,e.parent().hide())})},"a.carousel-control click":function(e,t){t.preventDefault()},".carousel-control.left click":function(){ga("set","page",decodeURI(document.location.href)),ga("send","event","MainCarousel","Left")},".carousel-control.right click":function(){ga("set","page",decodeURI(document.location.href)),ga("send","event","MainCarousel","Right")},".registration_button click":function(){ga("set","page",decodeURI(document.location.href)),ga("send","event","Registration","MainBanner")},destroy:function(){l.unbind.call(c,"toggleWatch",l.proxy(this.toggleWatch,this)),c.attr("user").user().unbind("change"),c.undelegate("subsChanged","set"),l.Control.prototype.destroy.call(this)}});return{get default(){return h},__esModule:!0}});
