/*modules/encyclopedia/encyclopedia*/
define("modules/encyclopedia/encyclopedia",["can/","controller","select2","core/appState","js/app/user/modules/encyclopedia/encyclopediaHelpers","lib/subscribe/","lib/helpers/pagination","custom-scrollbar"],function(t,e,i,a,s,r,l,n){"use strict";t&&t.__esModule||(t={"default":t}),e&&e.__esModule||(e={"default":e}),i&&i.__esModule||(i={"default":i}),a&&a.__esModule||(a={"default":a}),s&&s.__esModule||(s={"default":s}),r&&r.__esModule||(r={"default":r}),l&&l.__esModule||(l={"default":l}),n&&n.__esModule||(n={"default":n});var c=t["default"],o=e["default"],d=(i["default"],a["default"]),h=s["default"],u=r["default"],f=l["default"],m=c.Model.extend({findAll:"POST /themes/findAll",parseModels:function(t){return t.data.themes}},{}),p=(c.Model.extend({findAll:"POST /articles/findAll",parseModels:function(t){return t.data.articles}},{}),o.extend({defaults:{}},{variables:function(){this.active="active",this.age_blocks=this.element.find(".age_block"),this.theme_filter=this.element.find(".theme_filter"),this.bookshelf=this.theme_filter.find(".bookshelf"),this.items_container=this.element.find(".items_container")},plugins:function(){this.setFilterHeight(),this.select2()},select2:function(){var t={width:"off",minimumResultsForSearch:-1,formatResult:this.format},e=this.element.find(".author_select"),i=this.element.find(".order_select");e.select2(t),i.select2(t)},format:function(t){var e=$(t.element),i=e.data("count"),a='<div class="adorable_table encyclopedia_select2_result"><div class="adorable_cell"><span>'+t.text+"</span>"+("undefined"!=typeof i?'<div class="count">'+i+"</div>":"")+"</div></div>";return a},setFilterHeight:function(){var t=d.attr("viewport").getViewportHeight(),e=this.element.find(".age_filter"),i=e.height();t>=i?this.element.find(".filter").height(this.filterHeight=t):this.element.find(".filter").height(this.filterHeight=i)},"{window} resize":function(){this.setFilterHeight(),this.setScroll(),this.reRenderArticles()},after_init:function(t){this.articlesSource=t?t.articles.documents:app.articles.documents,this.articlesNextId=t?t.articles.nextAnchorId:app.articles.nextAnchorId,(this.articlesSource.length<24||1==this.articlesNextId||!this.articlesNextId)&&(this.noMoreArts=!0,this.element.find(".loadMore").hide()),this.isXL(t?t.themes:app.themes);var e,i,a=this,s=h.sortArticles(this.articlesSource,null,c.proxy(this.isXL,this));this.first_call=!0;var r=c.Map.extend({define:{age:{value:function(){var t=c.route.attr("id");return t?t:null}},theme:{value:function(){var t=c.route.attr("param2");return t?t:null}},themes:{value:t?new c.List(t.themes):new c.List(app.themes),get:function(t){var e={age:this.attr("age")};return a.first_call||t.replace(m.findAll(e)),t}}},ages:t?t.ages:app.ages,articles:s,sort:"desc",filter:0,module:"encyclopedia"});this.data=new r;var l=$("#bookshelf_mustache"),n=$("#encyclopedia_mustache");l.length?(i=l.html(),e=n.html()):(i=jadeTemplate.get("user/encyclopedia/bookshelf_mustache"),e=jadeTemplate.get("user/encyclopedia/encyclopedia_mustache")),c.view.mustache("bookshelf",i),c.view.mustache("encyclopedia_view",e),this.bookshelf.html(c.view("bookshelf",this.data,h)),this.items_container.html(c.view("encyclopedia_view",this.data,h)),this.first_call=!1,f.on(c.proxy(this.loadMore,this))},isXL:function(t){if(void 0!==this.isFirstXl)return this.isFirstXl;var e=this.data?this.data.attr("theme"):c.route.attr("param2");return this.isFirstXl=t.length?_.find(t,{_id:e}).isFirstCardXL||!1:!1,this.isFirstXl},reRenderArticles:function(){if(this.data){var t=h.sortArticles(this.getFilteredData(),this.data.attr("sort"),c.proxy(this.isXL,this));this.data.attr("articles",t)}},getFilteredData:function(){var t=this.data.attr("filter");switch(t){case 0:return this.articlesSource;case"Статья от редакции":case"Статья от специалиста":return _.filter(this.articlesSource,function(e){return e.type.name==t});case"Тема недели":return _.filter(this.articlesSource,function(t){return t.recommended})}},".age_block click":function(t){var e=t.data("value").toString();this.age_blocks.removeClass(this.active),t.addClass(this.active),this.data.attr("age",e),this.theme_filter.addClass(this.active),this.setScroll()},setScroll:function(){$(".filterContent",this.element).mCustomScrollbar({scrollInertia:0})},".book click":function(t){this.element.find(".book").removeClass(this.active),t.addClass(this.active),this.data.attr("theme",t.data("theme"));var e=this.data.attr("age")||null,i=t.data("theme")||null;router.new_module("encyclopedia"+(e?"/"+e:"")+(i?"/"+i:""))},".theme_filter .close click":function(t){this.theme_filter.removeClass(this.active)},".order_select change":function(t){var e=t.val();this.data.attr("sort","date"===e?"desc":"asc"),this.reRenderArticles()},".author_select change":function(t){this.data.attr("filter",t.val()),this.reRenderArticles()},".subscribeIt click":function(){var t=this;u.subscribe(this.data.attr("theme"),function(){t.element.find(".subscribeIt").hide(),t.element.find(".unSubscribeIt").show()})},".unSubscribeIt click":function(){var t=this;u.unsubscribe(this.data.attr("theme"),function(){t.element.find(".unSubscribeIt").hide(),t.element.find(".subscribeIt").show()})},loadMore:function(){var t=this,e=t.data.attr("articles"),i={lastId:t.articlesNextId};t.noMoreArts||(t.data.attr("theme")&&t.data.attr("age")&&(i.age={_id:_.find(t.data.attr("ages").attr(),{value:+t.data.attr("age")})._id},i.theme={_id:t.data.attr("theme")},i.nestedAnchor={wrap:"theme",field:"_id",value:t.data.attr("theme"),anchorField:"position"},i.sort={"theme.position":-1}),c.ajax({url:"/articles",method:"get",dataType:"json",data:i}).done(function(i){var a=h.sortArticles(i.documents,t.data.attr("sort"),c.proxy(t.isXL,t));t.articlesNextId=i.nextAnchorId,c.batch.start(),_.each(a,function(t){e.push(t)}),c.batch.stop(),(i.documents.length<24||1==t.articlesNextId||!t.articlesNextId)&&(t.noMoreArts=!0,$(".loadMore").hide())}))},destroy:function(){f.off(),c.Control.prototype.destroy.call(this)}}));return{get default(){return p},__esModule:!0}});