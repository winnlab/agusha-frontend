/*modules/main/main*/
define("modules/main/main",["can/","controller","core/appState","js/app/user/modules/encyclopedia/encyclopediaHelpers","lib/helpers/pagination","lodash","select2","carousel"],function(e,t,a,s,i,n,r,o){"use strict";e&&e.__esModule||(e={"default":e}),t&&t.__esModule||(t={"default":t}),a&&a.__esModule||(a={"default":a}),s&&s.__esModule||(s={"default":s}),i&&i.__esModule||(i={"default":i}),n&&n.__esModule||(n={"default":n}),r&&r.__esModule||(r={"default":r}),o&&o.__esModule||(o={"default":o});var l=e["default"],c=t["default"],d=a["default"],u=s["default"],h=i["default"],f=n["default"],m=c.extend({defaults:{}},{variables:function(){this.classname="active",this.tab_selectors=this.element.find(".tab_selector"),this.bannerWrap=this.element.find(".bannerWrap"),this.userTitle=this.element.find(".userTitle"),this.items_container=this.element.find(".items_container"),this.feed_container=this.element.find(".feed_container"),this.registration_block=this.element.find(".registration_block"),this.carousel=this.element.find("#main_carousel"),this.counter_block=this.element.find(".counter_block")},plugins:function(){this.init_carousel()},init_carousel:function(){var e=this;this.carousel.carousel({interval:!1}),this.carousel.on("slide.bs.carousel",function(){e.registration_block.removeClass("animate").addClass("no-transition"),setTimeout(function(){e.registration_block.removeClass("no-transition").addClass("animate")},4)})},initPlugins:function(){var e=this;this.select2(),d.delegate("subsChanged","set",function(t,a){a&&e.updateSubscribe()}),d.attr("user").user().bind("change",function(t,a,s,i,n){if(d.attr("user")&&d.attr("user").user()&&d.attr("user").user()._id){e.element.find(".carousel_container").hide();var r=d.attr("user").user().attr("profile.first_name");e.element.find(".breadcrumbs span").html("/ "+r),e.element.find(".username").html(r)}else e.element.find(".carousel_container").show()}),l.bind.call(d,"toggleWatch",l.proxy(this.toggleWatch,this))},toggleWatch:function(e,t,a){var s=(d.attr("user").user().attr("_id"),f.findIndex(this.data.attr("feed"),{_id:t}));return-1===s?(this.data.attr("feed").push(a),void this.feedSource.push(a)):(this.data.attr("feed").splice(s,1),void this.feedSource.splice(f.findIndex(this.feedSource,{_id:t}),1))},select2:function(){var e={width:"off",minimumResultsForSearch:-1,formatResult:this.format},t=this.element.find(".feed_select"),a=this.element.find(".order_select");t.select2(e),a.select2(e)},format:function(e){var t=$(e.element),a=t.data("count"),s='<div class="adorable_table main_select2_result"><div class="adorable_cell"><span>'+e.text+"</span>"+("undefined"!=typeof a?'<div class="count">'+a+"</div>":"")+"</div></div>";return s},after_init:function(e){var t=this,a=d.attr("user").auth;this.isAuth(null,a.attr("isAuth")),a.delegate("isAuth","set",f.bind(this.isAuth,this)),this.articlesSource=e?e.articles.documents:app.articles.documents,this.articlesNextId=e?e.articles.nextAnchorId:app.articles.nextAnchorId,this.themeSubs=e?e.themeSubs:app.themeSubs,this.consultations=e?e.consultations:app.consultations,this.feedSource=[].concat(this.themeSubs,this.consultations),(this.articlesSource.length<24||1==this.articlesNextId||!this.articlesNextId)&&(this.noMoreArts=!0,this.element.find(".loadMore").hide());var s,i,n=u.sortArticles(this.articlesSource,null,!0,!0),r=u.sortArticles(this.feedSource,null,!0,!0);this.data=new l.Map({articles:n,feed:r,feedLength:this.feedSource.length,sort:"desc",filter:0,iconFilter:null,feedFilter:0,module:"main",themeSubs:e?e.themeSubs.length:app.themeSubs.length,authorSubs:0,consultations:e?e.consultations.length:app.consultations.length}),window.data=this.data;var o=$("#encyclopedia_mustache"),c=$("#feed_mustache");s=o.length?o.html():jadeTemplate.get("user/encyclopedia/encyclopedia_mustache"),i=c.length?c.html():jadeTemplate.get("user/main/feed_mustache"),l.view.mustache("mainArticlesView",s),l.view.mustache("feedView",i),this.items_container.each(function(){$(this).html(l.view("mainArticlesView",t.data,u))}),this.feed_container.html(l.view("feedView",this.data,u)),this.initPlugins(),this.icons=this.element.find(".icon")},updateSubscribe:function(){var e=this;l.ajax({url:"/feed",method:"GET"}).done(function(t){e.themeSubs=t?t.themeSubs:[],e.consultations=t?t.consultations:[],e.feedSource=[].concat(e.themeSubs,e.consultations);var t=e.getFilteredData(),a=u.sortArticles(t,e.data.attr("sort"),!0,!0);e.data.attr("feed",a),e.data.attr("feedLength",e.feedSource.length),e.data.attr("themeSubs",e.themeSubs.length),e.data.attr("consultations",e.consultations.length),d.attr("subsChanged",!1)}).fail(function(){console.error(arguments)})},isAuth:function(e,t){h.off();var a=this;t?(a.element.find(".mainModuleWrap").addClass("logedIn"),a.bannerWrap.hide(),a.element.find(".commonFeed").hide(),a.element.find(".carousel_container").hide(),a.userTitle.css("display","inline-block")):(a.element.find(".mainModuleWrap").removeClass("logedIn"),a.userTitle.hide(),a.element.find(".commonFeed").show(),a.element.find(".carousel_container").show(),a.bannerWrap.show()),h.on(l.proxy(this.loadMore,this))},".tab click":function(e){var t=e.data("tab");this.tab_selectors.removeClass(this.classname),this.tab_selectors.filter("."+t).addClass(this.classname)},"{window} resize":function(){this.reRenderArticles(),this.reRenderFeed()},reRenderArticles:function(){if(this.data){var e=u.sortArticles(this.articlesSource,null,!0,!0);this.data.attr("articles",e)}},reRenderFeed:function(){if(this.data){var e=this.getFilteredData(),t=u.sortArticles(e,this.data.attr("sort"),!0,!0);this.data.attr("feed",t)}},".order_select change":function(e){var t=e.val();this.data.attr("sort","date"===t?"asc":"desc"),this.reRenderFeed()},".icon click":function(e){var t,a,s=this.data.attr("iconFilter"),i=e.data("filter"),n=this.getFilteredData(),r=i==s?!1:i;this.icons.removeClass("active"),this.data.attr("iconFilter")!==i&&e.addClass("active"),t=f.filter(n,function(e){if(!r)return!0;switch(r){case"watchers":var t=d.attr("user").user().attr("_id");return!(!e.watchers||-1===e.watchers.indexOf(t));case"recommended":return!!e.recommended;case"spec":return!!f.find(e.answer,function(e){return!!e.specialist})}return!1}),this.data.attr("iconFilter",i),a=u.sortArticles(t,this.data.attr("sort"),!0,!0),this.data.attr("feed",a)},".feed_select change":function(e){var t=+e.val();0===t&&this.data.attr("iconFilter",!1),this.data.attr("feedFilter",t),this.reRenderFeed()},getFilteredData:function(){var e=this.data.attr("feedFilter");return 0===e?this.feedSource:1===e?this.themeSubs:2===e?[]:3===e?this.consultations:void 0},loadMore:function(){console.info("loadMore");var e=this,t=e.data.attr("articles");e.noMoreArts||l.ajax({url:"/articles",method:"get",dataType:"json",data:{lastId:e.articlesNextId}}).done(function(a){f.each(a.documents,function(t){e.articlesSource.push(t)});var s=u.sortArticles(e.articlesSource,null,!0,!0);e.articlesNextId=a.nextAnchorId,l.batch.start(),f.each(s,function(e,a){t.attr(a)||t.push(e)}),l.batch.stop(),(a.documents.length<24||1==e.articlesNextId||!e.articlesNextId)&&(e.noMoreArts=!0,$(".loadMore").hide())})},"a.carousel-control click":function(e,t){t.preventDefault()},".carousel-control.left click":function(){ga("set","page",decodeURI(document.location.href)),ga("send","event","MainCarousel","Left")},".carousel-control.right click":function(){ga("set","page",decodeURI(document.location.href)),ga("send","event","MainCarousel","Right")},".registration_button click":function(){ga("set","page",decodeURI(document.location.href)),ga("send","event","Registration","MainBanner")},destroy:function(){l.unbind.call(d,"toggleWatch",l.proxy(this.toggleWatch,this)),d.attr("user").user().unbind("change"),d.undelegate("subsChanged","set"),d.attr("user").auth.undelegate("isAuth"),h.off(),l.Control.prototype.destroy.call(this)}});return{get default(){return m},__esModule:!0}});