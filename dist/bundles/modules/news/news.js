/*modules/news/news*/
define("modules/news/news",["controller","core/appState","js/app/user/modules/encyclopedia/encyclopediaHelpers","lib/helpers/pagination","select2"],function(e,t,a,s,r){"use strict";e&&e.__esModule||(e={"default":e}),t&&t.__esModule||(t={"default":t}),a&&a.__esModule||(a={"default":a}),s&&s.__esModule||(s={"default":s}),r&&r.__esModule||(r={"default":r});var i=e["default"],n=(t["default"],a["default"]),c=s["default"],l=(r["default"],i.extend({variables:function(){this.active="active",this.items_container=this.element.find(".items_container")},plugins:function(){this.select2()},select2:function(){var e={width:"off",minimumResultsForSearch:-1,formatResult:this.format},t=this.element.find(".author_select"),a=this.element.find(".order_select");t.select2(e),a.select2(e)},format:function(e){var t=$(e.element),a=(t.data("count"),'<div class="adorable_table news_select2_result"><div class="adorable_cell"><span>'+e.text+"</span></div></div>");return a},after_init:function(e){this.articlesSource=e?e.articles.documents:app.articles.documents,this.articlesNextId=e?e.articles.nextAnchorId:app.articles.nextAnchorId,(this.articlesSource.length<24||1==this.articlesNextId||!this.articlesNextId)&&(this.noMoreArts=!0,this.element.find(".loadMore").hide());var t,a=n.sortArticles(this.articlesSource,null);this.first_call=!0;var s=can.Map.extend({articles:a,filter:0,sort:"desc",module:"news"});this.data=new s;var r=$("#news_mustache");t=r.length?r.html():jadeTemplate.get("user/news/news_mustache"),can.view.mustache("news_view",t),this.items_container.html(can.view("news_view",this.data,n)),this.first_call=!1,c.on(can.proxy(this.loadMore,this))},reRenderArticles:function(){if(this.data){var e=n.sortArticles(this.getFilteredData(),this.data.attr("sort"));this.data.attr("articles",e)}},getFilteredData:function(){var e=this.data.attr("filter");switch(e){case 0:return this.articlesSource;case"Статья от редакции":case"Статья от специалиста":return _.filter(this.articlesSource,function(t){return t.type.name==e});case"Тема недели":return _.filter(this.articlesSource,function(e){return e.recommended})}},".order_select change":function(e){var t=e.val();this.data.attr("sort","date"===t?"desc":"asc"),this.reRenderArticles()},".author_select change":function(e){this.data.attr("filter",e.val()),this.reRenderArticles()},loadMore:function(){var e=this,t=e.data.attr("articles");e.noMoreArts||can.ajax({url:"/news-list",method:"get",dataType:"json",data:{lastId:e.articlesNextId}}).done(function(a){_.each(a.documents,function(t){e.articlesSource.push(t)});var s=n.sortArticles(e.articlesSource,null,!0,!0);e.articlesNextId=a.nextAnchorId,can.batch.start(),_.each(s,function(e,a){t.attr(a)||t.push(e)}),can.batch.stop(),(a.documents.length<24||1==e.articlesNextId||!e.articlesNextId)&&(e.noMoreArts=!0,$(".loadMore").hide())})},destroy:function(){c.off(),can.Control.prototype.destroy.call(this)}}));return{get default(){return l},__esModule:!0}});